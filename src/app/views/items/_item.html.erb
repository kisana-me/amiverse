<% if defined? show_replying %>
    <% if !item.replying.empty? %>
      <% item.replying.each do |reply| %>
        <%= render 'items/item', item: reply, showing: 'showing' %>
      <% end %>
    <% end %>
<% end %>

<div class="item" id="item_<%= item.aid %>">
  <div class="item-left">
    <div class="item-left-top <%= (defined? full_display) ? 'ilt-full' : 'ilt-summary' %><%= ((defined? show_replying) || (defined? showing)) && item.replying.present? ? ' il-display' : '' %>">
    </div>
    <% middle_flag = (((defined? show_replying) || (defined? showing)) && item.replying.present?) || (((defined? show_repliers) || (defined? showing)) && item.repliers.present?) %>
    <div class="item-left-middle<%= middle_flag ? ' il-display' : '' %>"></div>
    <div class="item-left-bottom <%= (defined? full_display) ? 'ilb-full' : 'ilb-summary' %><%= ((defined? show_repliers) || (defined? showing)) && item.repliers.present? ? ' il-display' : '' %>">
    </div>
  </div>
  <div class="item-wrap">
    <div class="item-account">
      <% if defined? full_display %>
        <div class="item-account-badges">
          <%= link_to emojis_path, class: 'iab-badge',
          style: 'border-color: #5CFF23; background: #5CFF2355;' do %>
            <div class="iab-icon">üç≠</div>
            <div class="iab-name">
              ÈñãÁô∫ËÄÖ
            </div>
          <% end %>
          <%= link_to emojis_path, class: 'iab-badge',
          style: 'border-color: #48E9FF; background: #48E9FF55;' do %>
            <div class="iab-icon">‚ú®</div>
            <div class="iab-name">
              TESTER
            </div>
          <% end %>
        </div>
      <% end %>
      <div class="item-account-info">
        <%= link_to account_path(item.account.name_id), class: 'iai-plate' do %>
          <% if item.account.icon %>
            <%= image_tag item.account.icon.image_url(variant_type: 'icons'), class: 'iai-icon' %>
          <% else %>
            <img src="/images/icon.webp" class="iai-icon" />
          <% end %>
          <div class="iai-nameplate">
            <div class="iai-name">
              <%= item.account.name %>
            </div>
            <div class="iai-name_id">
              @<%= item.account.name_id %>
            </div>
          </div>
        <% end %>
        <% if defined? full_display %>
          <div class="iai-others">
            <% if @current_account && @current_account.following.map(&:id).include?(item.account.id) %>
              <%= button_to("„Éï„Ç©„É≠„Éº‰∏≠", follow_path(item.account.name_id), class: 'iai-button', method: :post) %>
            <% elsif @current_account %>
              <% if @current_account == item.account %>
                <%= button_to("„Éó„É≠„Éï„Ç£„Éº„É´", account_path(@current_account.name_id), class: 'iai-button', method: :get) %>
              <% else %>
                <%= button_to("„Éï„Ç©„É≠„Éº", follow_path(item.account.name_id), class: 'iai-button', method: :post) %>
              <% end %>
            <% else %>
              <%= button_to('„É≠„Ç∞„Ç§„É≥', login_path, class: 'iai-button', method: :get) %>
            <% end %>
          </div>
        <% end %>
      </div>
    </div>
    <% if defined? full_display %>
      <div class="item-details">
        <div class="id-tags">
          <% if item.replying.size > 0 %>
            <%= link_to item_path(item.aid), class: 'id-tag' do %>
              <div class="id-tag-icon">‚Üê</div>
              <div class="id-tag-name">Ëøî‰ø°</div>
            <% end %>
          <% end %>
          <% if item.quoting.size > 0 %>
            <%= link_to item_path(item.aid), class: 'id-tag' do %>
              <div class="id-tag-icon">‚Üí</div>
              <div class="id-tag-name">ÂºïÁî®</div>
            <% end %>
          <% end %>
        </div>
        <%= link_to item_path(item.aid), class: 'id-text' do %>
          <%= item.human_attribute_enum(:visibility) %>„Éª<%= item.created_at.strftime("%Y/%m/%d/ %k:%M:%S") %>
        <% end %>
      </div>
    <% else %>
      <div class="item-summary-details">
        <div class="">
          <%= link_to item_path(item.aid), class: 'id-text' do %>
            <%= item.human_attribute_enum(:visibility) %>
            <%= "„Éª#{item.human_attribute_enum(:usage_type)}" if (item.usage_type != 'personal') %>
            <%= '„ÉªËøî‰ø°' if (item.replying.size > 0) %>
            <%= '„ÉªÂºïÁî®' if (item.quoting.size > 0) %>
          <% end %>
        </div>
        <div class="">
          <%= link_to item_path(item.aid), class: 'id-text' do %>
            <%= item.viewed_counter %>Âõû„Éª<%= item.created_at.strftime("%m/%d/ %k:%M") %>
          <% end %>
        </div>
      </div>
    <% end %>
    <div class="item-content">
      <%= safe_join(item.content.split("\n"),tag(:br)) %>
    </div>
    <div class="item-media" data-controller="image-viewer">


      <% item.images.each do |image| %>
        <%= image_tag image.image_url, class: 'item-image', data: { action: "click->image-viewer#openViewer", image_viewer_target: "previewImage" } %>
      <% end %>

      <div class="fullscreen-image-viewer hidden" data-image-viewer-target="viewer">
        <div class="fiv-background" data-image-viewer-target="background" data-action="click->image-viewer#closeImage"></div>
        <div class="fiv-container" data-image-viewer-target="container"></div>
        <button class="fiv-reset" data-image-viewer-target="reset" data-action="click->image-viewer#resetImage">‚Ü∫</button>
        <button class="fiv-close" data-image-viewer-target="close" data-action="click->image-viewer#closeImage">√ó</button>
        <button class="fiv-prev" data-image-viewer-target="prev" data-action="click->image-viewer#prevImage">‚óÄ</button>
        <button class="fiv-next" data-image-viewer-target="next" data-action="click->image-viewer#nextImage">‚ñ∂</button>
      </div>







      <% item.canvases.each do |canvas| %>
        <%= image_tag canvas.image_url, class: 'item-image', style: 'image-rendering: pixelated;' %>
      <% end %>
      <% if false %>
        <video controls class='video-view' id='video-<%= video.video_id %>'></video>
        <script src="https://cdn.jsdelivr.net/npm/hls.js@1"></script>
        <script>
          var video = document.getElementById('video-<%= video.video_id %>');
          var videoSrc = 'http://localhost:9000/development/variants/accounts/00000000000000/videos/<%= video.video_id %>/output.m3u8';
          if (Hls.isSupported()) {
            var hls = new Hls();
            hls.loadSource(videoSrc);
            hls.attachMedia(video);
          }
        </script>
      <% end %>
    </div>
    <% if defined? full_display %>
      <div class="item-details">
        <div class="id-tags">
          <% if item.usage_type != 'personal' %>
            <%= link_to item_path(item.aid), class: 'id-tag' do %>
              <div class="id-tag-icon">‚ùï</div>
              <div class="id-tag-name"><%= item.human_attribute_enum(:usage_type) %></div>
            <% end %>
          <% end %>
        </div>
        <%= link_to item_path(item.aid), class: 'id-text' do %>
          <%= item.viewed_counter %>Âõû„Éª<%= item.aid %>
        <% end %>
      </div>
    <% end %>
    <div class="item-reactions">
      <% if item.emojis.blank? %>
      <% else %>
        <% item.emojis.each do |emoji| %>
          <% react_flag = @current_account && Reaction.exists?({
          account_id: @current_account.id,
          emoji_id: emoji.id,
          item_id: item.id
          }) %>
          <%= button_to item_react_path(item.aid), params: {emoji_aid: emoji.aid}, method: :post, class: 'ir-reaction',
          style: "border-color: ##{react_flag ? 'ff4848' : 'DA48FF'}; background: ##{react_flag ? 'ff484855' : 'DA48FF55'};" do %>
            <div class="ir-emoji">
              <%= emoji.name %>
            </div>
            <div class="ir-count">
              <%= item.reactions.where(emoji_id: emoji.id).size %>
            </div>
            <% end %>
        <% end %>
      <% end %>
    </div>
    <div class="item-panel">
      <div class="ip-button ip-menu popup-menu" data-controller="popup-menu" data-action="click->popup-menu#toggleMenu" data-popup-menu-target="menuButton">
        <div class="ipb-icon">
          <%= render 'svgs/item/menu' %>
        </div>
        <div data-popup-menu-target="menu" class="menu" style="display: none;">
          <button class="menu-item">„É™„Çπ„Éà„Å´ËøΩÂä†</button>
          <button class="menu-item">„Ç∑„Çß„Ç¢„Åô„Çã</button>
          <button class="menu-item">ËààÂë≥„Åå„Å™„ÅÑ</button>
          <button class="menu-item">„Éï„Ç©„É≠„Éº/Ëß£Èô§</button>
          <button class="menu-item">„Éü„É•„Éº„Éà„Åô„Çã</button>
          <button class="menu-item">„Éñ„É≠„ÉÉ„ÇØ„Åô„Çã</button>
          <button class="menu-item">„Ç¢„Éä„É™„ÉÜ„Ç£„ÇØ„Çπ</button>
          <button class="menu-item">Âüã„ÇÅËæº„ÇÄ</button>
          <button class="menu-item">Â†±Âëä„Åô„Çã</button>
        </div>
      </div>
      <%= link_to item_quote_path(item.aid), data: { turbo_stream: true }, class: 'ip-button ip-quote' do %>
        <div class="ipb-icon"><%= render 'svgs/item/quote' %></div>
        <div class="ipb-number"><%= item.quoters.size %></div>
      <% end %>
      <div class="ip-button ip-diffuse">
        <div class="ipb-icon"><%= render 'svgs/item/diffuse' %></div>
        <div class="ipb-number"><%= 0 %></div>
      </div>
      <%= link_to item_reply_path(item.aid), data: { turbo_stream: true }, class: 'ip-button ip-reply' do %>
        <div class="ipb-icon"><%= render 'svgs/item/reply' %></div>
        <div class="ipb-number"><%= item.repliers.size %></div>
      <% end %>
      <%= link_to item_react_path(item.aid), data: { turbo_stream: true }, class: 'ip-button ip-react' do %>
        <div class="ipb-icon"><%= render 'svgs/item/reaction' %></div>
        <div class="ipb-number"><%= item.reactions.size %></div>
      <% end %>
    </div>
    <div class="item-console">
      <% if (defined? initial_replied) %>
        Ëøî‰ø°„Åô„Çã
        <%= render 'items/form', initial_replied: initial_replied %>
      <% end %>
      <% if (defined? initial_quoted) %>
        ÂºïÁî®„Åô„Çã
        <%= render 'items/form', initial_quoted: initial_quoted %>
      <% end %>
      <% if defined? emojis %>
        ÂèçÂøú„Åô„Çã
        <% emojis.each do |emoji| %>
          <%= button_to item_create_react_path(@item.aid), params: {emoji_aid: emoji.aid}, method: :post do %>
            <% if false %>
              <%= image_tag image_url(model: 'emojis', type: 'tb-emojis', aid: emoji.aid), class: '' %>
            <% else %>
              <%= emoji.name %>
            <% end %>
          <% end%>
        <% end %>
      <% end %>
    </div>
  </div>
</div>

<% if defined? show_repliers %>
    <% if !item.repliers.empty? %>
      <% item.repliers.each do |reply| %>
        <%= render 'items/item', item: reply, showing: 'showing' %>
      <% end %>
    <% end %>
<% end %>